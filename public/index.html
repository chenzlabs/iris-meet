<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Iris Meet</title>

<!-- Origin Trial Token, feature = WebVR (For Chrome M59+), origin = https://chenz.org, expires = 2017-07-27 -->
<meta http-equiv="origin-trial" data-feature="WebVR (For Chrome M59+)" data-expires="2017-07-27" content="AnbbVJhmxzU0Nk7Mk6k/txkLLQRBslbORrg+19ggLaM3/EVlYxTeR5Uy5EW7moQjXyh3HUgSUBkY9TYnUJQadwIAAABeeyJvcmlnaW4iOiJodHRwczovL2NoZW56Lm9yZzo0NDMiLCJmZWF0dXJlIjoiV2ViVlIxLjEiLCJleHBpcnkiOjE1MDExNjY2MDAsImlzU3ViZG9tYWluIjp0cnVlfQ==">

    <link rel="stylesheet" href="fa/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <!--<link rel="stylesheet" href="style.css">-->
    <script src="https://rawgit.com/chenzlabs/aframe/master/dist/aframe-master.min.js"></script>
    <style>
        /* for VR, hide the 2D elements in favor of A-Frame representations */
        .main-video, .later-toolbarShow, .videoBarShow { visibility:hidden !important; }

        /* not sure if these are still needed if we keep the videoBar hidden */
        .horizontal-box video { pointer-events: all; }
        #footer { pointer-events: none; }

        /* make sure A-Frame scene takes up fullscreen, or else enter-VR button won't show */
        a-scene { position: absolute; left: 0; top: 0; right: 0; bottom: 0; overflow: hidden; }
    </style>

<!-- for arrow key rotation -->
<script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v2.7.3/dist/aframe-extras.controls.min.js"></script>
<script>
    var PiBy180 = Math.PI / 180.0;

    // allow arrow keys toperform rotation
    // NOTE: should really be in its own component JS file
    AFRAME.registerComponent('arrow-key-rotation', {
        // needs keyboard-controls from donmccurdy's extras
        dependencies: ['keyboard-controls'],
        schema: {},
        tick: function (time, timeDelta) {
            var kc = this.el.components['keyboard-controls'];
            if (kc && kc.isVelocityActive()) {
                var data = kc.getVelocityDelta();
                var object3D = this.el.object3D;
                object3D.rotationAutoUpdate = false;
                object3D.rotation.x -= data.z * PiBy180;
                object3D.rotation.y -= data.x * PiBy180;
            }
        }
    });
</script>

<!-- make tracked controllers emit cursor events on down/up events -->
<script>
  AFRAME.registerComponent('controller-cursor', {
    dependencies: ['cursor'],

    // daydream-controller doesn't have a trigger.
    schema: {
      downEvents: {type: 'array', default: ['triggerdown', 'trackpaddown', 'thumbstickdown']},
      upEvents: {type: 'array', default: ['triggerup', 'trackpadup', 'thumbstickup']},
    },
    
    init: function () {
      // We want to use controller buttons, so don't fuse.
      this.el.setAttribute('cursor', 'fuse', false);
      this.onDown = this.onDown.bind(this);
      this.onUp = this.onUp.bind(this);
    },
    
    play: function () {
      var el = this.el;
      // Samsung Internet doesn't like ES6 syntax!
      var self = this;
      this.data.downEvents.forEach(function (eventName) {
        el.addEventListener(eventName, self.onDown);
      });
      this.data.upEvents.forEach(function (eventName) {
        el.addEventListener(eventName, self.onUp);
      });
    },
    
    pause: function () {
      var el = this.el;
      // Samsung Internet doesn't like ES6 syntax!
      var self = this;
      this.data.downEvents.forEach(function (eventName) {
        el.removeEventListener(eventName, self.onDown);
      });
      this.data.upEvents.forEach(function (eventName) {
        el.removeEventListener(eventName, self.onUp);
      });
    },
    
    onDown: function (evt) {
      this.el.components.cursor.onMouseDown();
    },
    onUp: function (evt) {
      this.el.components.cursor.onMouseUp();
    }
  });
</script>


<script>
  AFRAME.registerComponent("controller-model-if-present", {
    controllerComponents: ['oculus-touch-controls', 'vive-controls', 'daydream-controls', 'gearvr-controls'],
    schema: { type: 'string' },
    init: function () {
      var el = this.el;
      // install event handler
      el.addEventListener('controllerconnected', function (evt) {
        // we've got something, make it visible
        el.setAttribute('visible', true);
        // undo hand-model rotation offset
        el.setAttribute('tracked-controls', 'rotationOffset', 0);
        el.setAttribute(evt.detail.name, 'rotationOffset', 0);
        // use controller model
        el.setAttribute(evt.detail.name, 'model', true);
        // setAttribute doesn't make model appear, so force
        evt.detail.component.updateControllerModel();
      });

      // Use various controller components,
      this.controllerComponents.forEach(function(name) { this.el.setAttribute(name, 'hand', this.data); }.bind(this));
      // but hide by default.
      this.el.setAttribute('visible', false);
    }
  });
</script>

<script>
  AFRAME.registerComponent("controller-with-cursor-if-present", {
    schema: {type: 'string'},
    init: function() {
      this.el.setAttribute('controller-model-if-present', this.data);

      // Create ray as visible guide for selection.
      // NOTE: make sure cursor/raycaster won't intersect!
      var ray = document.createElement('a-box');
      ray.setAttribute('class', 'not-clickable');
      ray.setAttribute('width', 0.001);
      ray.setAttribute('height', 0.001);
      ray.setAttribute('depth', 100);
      ray.setAttribute('position', {x:0, y:0, z: -50});
      ray.setAttribute('color', 'green');
      ray.setAttribute('opacity', 0.25);
      this.el.appendChild(ray);

      this.el.addEventListener('controllerconnected', function (evt) {
        // if we had a raycaster, cursor, etc., attach here
        evt.target.setAttribute('controller-cursor', '');
        // need to make ray NOT an intersection target for raycaster!
        evt.target.setAttribute('raycaster', 'interval:100; objects:.clickable');

        // Since we have a controller, remove gaze cursor.
        var cameraCursorEl = document.querySelector('a-camera a-entity[cursor]');
        if (cameraCursorEl) {
          cameraCursorEl.parentElement.removeChild(cameraCursorEl);
        }
      });
    }
  });
</script>

<!-- syntactical sugar for CSS class clickable for entities to be returned by cursor raycasters -->
<script>
  AFRAME.registerComponent('clickable', {
    init: function () { this.el.classList.add('clickable'); },
    remove: function () { this.el.classList.remove('clickable'); }
  });
</script>

</head>
<body>
    <div id="target">Loading ...</div>
    <script src="iris-rtc-js-sdk.1.0.23.js"></script>
<script>
  // handle 2D browser window click
  // also happening for Daydream
  // need to make sure it doesn't fire for Vive/Touch though (two cursors)
  function raycast2DClick() {
    // Samsung Internet doesn't like forEach directly from querySelectorAll!
    Array.prototype.slice.call(document.querySelectorAll('[cursor]')).forEach(function (cursorEl) {
      var raycaster = cursorEl.components.raycaster;
      if (raycaster.intersectedEls && raycaster.intersectedEls.length) {
        var el = raycaster.intersectedEls[0];
        el.dispatchEvent(new CustomEvent('click', {detail: {el: el}})); 
      }
    });
  }
  window.addEventListener('click', raycast2DClick);
  window.addEventListener('keydown', function(evt) { if (evt.keyCode === 13) { raycast2DClick(); } });
</script>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
</html>
